<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.98.0"><meta name=generator content="Relearn 3.4.1"><meta name=description content><meta name=author content="Choria Project"><title>Handlers in Docker :: Choria Async Jobs Documentation</title><link href=https://choria-io.github.io/asyncjobs/css/nucleus.css?1653319849 rel=stylesheet><link href=https://choria-io.github.io/asyncjobs/css/fontawesome-all.min.css?1653319849 rel=stylesheet><link href=https://choria-io.github.io/asyncjobs/css/featherlight.min.css?1653319849 rel=stylesheet><link href=https://choria-io.github.io/asyncjobs/css/perfect-scrollbar.min.css?1653319849 rel=stylesheet><link href=https://choria-io.github.io/asyncjobs/css/auto-complete.css?1653319849 rel=stylesheet><link href=https://choria-io.github.io/asyncjobs/css/theme.css?1653319849 rel=stylesheet><link href=https://choria-io.github.io/asyncjobs/css/theme-relearn-light.css?1653319849 rel=stylesheet id=variant-style><link href=https://choria-io.github.io/asyncjobs/css/variant.css?1653319849 rel=stylesheet><link href=https://choria-io.github.io/asyncjobs/css/print.css?1653319849 rel=stylesheet media=print><style>:not(pre)>code.copy-to-clipboard-code+span.copy-to-clipboard-button{display:none}:not(pre)>code.copy-to-clipboard-code{border-bottom-right-radius:2px;border-top-right-radius:2px;border-right-width:1px}</style><script src=https://choria-io.github.io/asyncjobs/js/variant.js?1653319849></script>
<script>var index_url="https://choria-io.github.io/asyncjobs/index.json",baseUriFull,root_url="https://choria-io.github.io/asyncjobs/",baseUri=root_url.replace(/\/$/,'');window.T_Copy_to_clipboard="Copy to clipboard",window.T_Copied_to_clipboard="Copied to clipboard!",window.T_Copy_link_to_clipboard="Copy link to clipboard",window.T_Link_copied_to_clipboard="Copied link to clipboard!",baseUriFull="https://choria-io.github.io/asyncjobs/",variants.init(["relearn-light","relearn-dark","asyncjobs"])</script><script src=https://choria-io.github.io/asyncjobs/js/jquery.min.js?1653319849></script></head><body class=mobile-support data-url=https://choria-io.github.io/asyncjobs/overview/handlers-docker/><div id=body class=default-animation><div id=sidebar-overlay></div><div id=toc-overlay></div><nav id=topbar class=highlightable><div><div class=navigation><a class="nav nav-next" href=https://choria-io.github.io/asyncjobs/overview/handlers-k8s/ title="Handlers in K8s"><i class="fas fa-chevron-right fa-fw"></i></a></div><div class=navigation><a class="nav nav-prev" href=https://choria-io.github.io/asyncjobs/overview/scheduled-tasks/ title="Scheduled Tasks"><i class="fas fa-chevron-left fa-fw"></i></a></div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle title=Menu><i class="fas fa-bars fa-fw"></i></a></span>
<span id=toc-menu title="Table of Contents"><i class="fas fa-list-alt fa-fw"></i></span><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><meta itemprop=itemListOrder content="Descending"><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="3"><a itemprop=item href=https://choria-io.github.io/asyncjobs/><span itemprop=name>Choria Async Jobs</span></a> ></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="2"><a itemprop=item href=https://choria-io.github.io/asyncjobs/overview/><span itemprop=name>Overviews</span></a> ></li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><meta itemprop=position content="1"><a itemprop=item href=https://choria-io.github.io/asyncjobs/overview/handlers-docker/ aria-disabled=true><span itemprop=name>Handlers in Docker</span></a></li></ol></div><div class="default-animation progress"><div class=wrapper><nav id=TableOfContents><ul><li><a href=#preparing-handlers>Preparing Handlers</a><ul><li><a href=#go-based>Go Based</a></li><li><a href=#other-languages>Other Languages</a></li></ul></li><li><a href=#packaging>Packaging</a></li><li><a href=#running>Running</a></li><li><a href=#environment-configuration>Environment Configuration</a></li></ul></nav></div></div></div></nav><main id=body-inner class=highlightable><div class=flex-block-wrapper><div id=head-tags></div><article><h1>Handlers in Docker</h1><p>We want to make it really easy to run handler services in Docker, toword that version <code>0.0.4</code> introduces a packager that can create containers on your behalf.</p><h2 id=preparing-handlers>Preparing Handlers</h2><h3 id=go-based>Go Based</h3><p>The idea is that you would create a Handler per Go package, the packager will then pull in all the configured handlers into a small microservice.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>handler</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>aj</span> <span style=color:#e6db74>&#34;github.com/choria-io/asyncjobs&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>AsyncJobHandler</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>log</span> <span style=color:#a6e22e>aj</span>.<span style=color:#a6e22e>Logger</span>, <span style=color:#a6e22e>task</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>aj</span>.<span style=color:#a6e22e>Task</span>) (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// process your email
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>Place this in any package you like, for example <code>git.example.com/example/email/new</code>. You can have many handlers, as long as they are in packages like here.</p><h3 id=other-languages>Other Languages</h3><p>Other languages are supported using NATS Request-Reply, implement them according to the protocol describe in <a href=../../reference/request-reply/>Remote Request-Reply Handlers</a>.</p><h2 id=packaging>Packaging</h2><p>In a empty directory create a file <code>asyncjobs.yaml</code> with the following content:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># The NATS Context to connect with.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Same as NatsContext() client option</span>
</span></span><span style=display:flex><span><span style=color:#f92672>nats</span>: <span style=color:#ae81ff>AJ_EMAIL</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># The Work Queue to consume.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Same as BindWorkQueue() client option</span>
</span></span><span style=display:flex><span><span style=color:#f92672>queue</span>: <span style=color:#ae81ff>EMAIL</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># The package name to generate</span>
</span></span><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>git.example.com/example</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># The version of github.com/choria-io/asyncjobs to use,</span>
</span></span><span style=display:flex><span><span style=color:#75715e># something go get would accept. Defeaults to the same</span>
</span></span><span style=display:flex><span><span style=color:#75715e># as the CLI version</span>
</span></span><span style=display:flex><span><span style=color:#f92672>asyncjobs</span>: <span style=color:#ae81ff>latest</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Use the RetryLinearTenMinutes retry policy,</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Equivelant to client RetryBackoffPolicyName() option</span>
</span></span><span style=display:flex><span><span style=color:#f92672>retry</span>: <span style=color:#ae81ff>10m</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Discard tasks that reach complete state.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Same as DiscardTaskStates() client option</span>
</span></span><span style=display:flex><span><span style=color:#f92672>discard</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>completed</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># List of Task handlers</span>
</span></span><span style=display:flex><span><span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>type</span>: <span style=color:#ae81ff>email:new</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>package</span>: <span style=color:#ae81ff>git.example.com/example/email/new</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>version</span>: <span style=color:#ae81ff>v0.2.0</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>type</span>: <span style=color:#ae81ff>audit:log</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>remote</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>type</span>: <span style=color:#ae81ff>webhook:call</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>: <span style=color:#ae81ff>webhook/call.sh</span>
</span></span></code></pre></div><p>We set up a <code>remote: true</code> Task handler for <code>audit:log</code> Tasks, this will delegate to external processes, see <a href=../../reference/request-reply/>Remote Request Reply Handlers</a>.</p><p>The <code>webhook:call</code> Task handler is a shell script that should exist in <code>commands/webhook/call.sh</code>, it will be copied into the container. It&rsquo;s most likely you will need dependencies not in the default container, I suggest using the generated one as a <code>FROM</code> container to derive one with your dependencies met via the alpine package system.</p><p>Next we create our package:</p><pre tabindex=0><code>$ ajc package docker
╭────────────────────────────────────────────────────────────────╮
│                 Handler Microservice Settings                  │
├────────────────────────────────┬───────────────────────────────┤
│ Package Name                   │ git.example.com/example       │
│ NATS Context Name              │ AJ_EMAIL                      │
│ Work Queue                     │ EMAIL                         │
│ Task Handlers                  │ 2                             │
│ github.com/choria-io/asyncjobs │ latest                        │
╰────────────────────────────────┴───────────────────────────────╯

╭───────────────────────────────────────────────────────────────────────────────────────────────╮
│                              Handler Configuration and Packages                               │
├──────────────┬───────────────────────┬────────────────────────────────────────────────────────┤
│ Task Type    │ Handler Kind          │ Detail                                                 │
├──────────────┼───────────────────────┼────────────────────────────────────────────────────────┤
│ email:new    │ Go Package            │ git.example.com/example/email/new@v0.2.0               │
│ webhook:call │ External Command      │ webhook/call.sh                                        │
│ audit:log    │ Request-Reply Service │ CHORIA_AJ.H.T.audit:log                                │
╰──────────────┴───────────────────────┴────────────────────────────────────────────────────────╯

Build your container using &#39;docker build&#39;

$ ls -l
total 12
-rw-rw-r-- 1 rip rip  166 Feb  8 17:48 asyncjobs.yaml
-rw-r--r-- 1 rip rip  713 Feb  8 20:01 Dockerfile
-rw-r--r-- 1 rip rip 2540 Feb  8 20:01 main.go
drwxrwxr-x 3 rip rip   19 Feb  8 17:48 commands
</code></pre><p>You see we have a <code>main.go</code> that will be built into a container:</p><pre tabindex=0><code>$ docker build . --tag example/email:latest
$ docker push example/email:latest
</code></pre><h2 id=running>Running</h2><p>The container will rely on a NATS Context for connectivity options, lets create one in the same directory:</p><pre tabindex=0><code>$ pwd 
/home/myname/work/email_service
$ XDG_CONFIG_HOME=`pwd` nats context add AJ_EMAIL --server nats://nats.example.net:4222
NATS Configuration Context &#34;AJ_EMAIL&#34;

      Server URLs: nats.example.net:4222
             Path: /home/myname/work/email_service/nats/context/AJ_EMAIL.json
</code></pre><p>We can now run it:</p><pre tabindex=0><code>$ docker run -ti -v &#34;/home/myname/work/email_service/nats:/handler/config/nats&#34; -p 8080:8080 --rm example/email:latest
INFO[19:07:39] Connecting using Context AJ_EMAIL consuming work queue EMAIL with concurrency 4
WARN[19:07:39] Exposing Prometheus metrics on port 8080
</code></pre><p>Note we mount the <code>nats</code> configuration directory into <code>/handler/config/nats</code> which is where the container will look for the context configuration. Should you need other supporting files like credentials you can place them in the container and reference them at their in-container paths.</p><h2 id=environment-configuration>Environment Configuration</h2><p>A few environment variables can be set to influence the container:</p><table><thead><tr><th>Variable</th><th>Description</th><th>YAML Item</th></tr></thead><tbody><tr><td><code>AJ_WORK_QUEUE</code></td><td>The name of the Queue to connect to</td><td><code>queue</code></td></tr><tr><td><code>AJ_NATS_CONTEXT</code></td><td>The NATS context to use for connectivity</td><td><code>nats</code></td></tr><tr><td><code>XDG_CONFIG_HOME</code></td><td>The prefix for NATS Context configuration, defaults to <code>/handler/config</code></td><td></td></tr><tr><td><code>AJ_CONCURRENCY</code></td><td>The number of workers to run, defaults to <code>runtime.NumCPU()</code></td><td></td></tr><tr><td><code>AJ_DEBUG</code></td><td>Set to <code>1</code> to enable debug logging</td><td></td></tr><tr><td><code>AJ_RETRY_POLICY</code></td><td>Sets the Retry Backoff Policy, one of <code>10m</code>, <code>1h</code>, <code>1m</code>, <code>default</code></td><td><code>retry</code></td></tr></tbody></table><footer class=footline></footer></article></div></main></div><aside id=sidebar class=default-animation><div id=header-wrapper class=default-animation><div id=header class=default-animation><img src=https://choria-io.github.io/asyncjobs/logo.png></div><div class="searchbox default-animation"><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script src=https://choria-io.github.io/asyncjobs/js/lunr.min.js?1653319849></script>
<script src=https://choria-io.github.io/asyncjobs/js/auto-complete.js?1653319849></script>
<script src=https://choria-io.github.io/asyncjobs/js/search.js?1653319849></script></div><div id=homelinks class=default-animation><ul><li><a class=padding href=https://choria-io.github.io/asyncjobs/><i class="fas fa-home"></i> Home</a></li></ul></div><div id=content-wrapper class=highlightable><ul class=topics><li data-nav-id=/overview/ title=Overviews class="dd-item parent alwaysopen"><input type=checkbox id=section-d777480ed79062ea8f809a7116e81e75 class=toggle checked><label for=section-d777480ed79062ea8f809a7116e81e75></label><a href=https://choria-io.github.io/asyncjobs/overview/>Overviews</a><ul><li data-nav-id=/overview/golang-overview/ title="Golang Walkthrough" class=dd-item><a href=https://choria-io.github.io/asyncjobs/overview/golang-overview/>Golang Walkthrough</a></li><li data-nav-id=/overview/cli-overview/ title="CLI Walkthrough" class=dd-item><a href=https://choria-io.github.io/asyncjobs/overview/cli-overview/>CLI Walkthrough</a></li><li data-nav-id=/overview/scheduled-tasks/ title="Scheduled Tasks" class=dd-item><a href=https://choria-io.github.io/asyncjobs/overview/scheduled-tasks/>Scheduled Tasks</a></li><li data-nav-id=/overview/handlers-docker/ title="Handlers in Docker" class="dd-item active"><a href=https://choria-io.github.io/asyncjobs/overview/handlers-docker/>Handlers in Docker</a></li><li data-nav-id=/overview/handlers-k8s/ title="Handlers in K8s" class=dd-item><a href=https://choria-io.github.io/asyncjobs/overview/handlers-k8s/>Handlers in K8s</a></li></ul></li><li data-nav-id=/reference/ title=References class="dd-item alwaysopen"><input type=checkbox id=section-2239954301764a827b7fd6ccce9a99d7 class=toggle checked><label for=section-2239954301764a827b7fd6ccce9a99d7></label><a href=https://choria-io.github.io/asyncjobs/reference/>References</a><ul><li data-nav-id=/reference/task-lifecycle/ title="Tasks lifecycle" class=dd-item><a href=https://choria-io.github.io/asyncjobs/reference/task-lifecycle/>Tasks lifecycle</a></li><li data-nav-id=/reference/routing-concurrency-retry/ title="Routing, Concurrency, Retry" class=dd-item><a href=https://choria-io.github.io/asyncjobs/reference/routing-concurrency-retry/>Routing, Concurrency, Retry</a></li><li data-nav-id=/reference/request-reply/ title="Request-Reply Handlers" class=dd-item><a href=https://choria-io.github.io/asyncjobs/reference/request-reply/>Request-Reply Handlers</a></li><li data-nav-id=/reference/lifecycle-events/ title="Lifecycle Events" class=dd-item><a href=https://choria-io.github.io/asyncjobs/reference/lifecycle-events/>Lifecycle Events</a></li><li data-nav-id=/reference/terminology/ title=Terminology class=dd-item><a href=https://choria-io.github.io/asyncjobs/reference/terminology/>Terminology</a></li></ul></li></ul><div id=shortcuts><div class=nav-title>More</div><ul><li><a class=padding href=https://github.com/choria-io/asyncjobs><i class="fab fa-fw fa-github"></i> GitHub</a></li><li><a class=padding href=https://github.com/choria-io/asyncjobs/releases><i class="far fa-save"></i> Download</a></li><li><a class=padding href=https://github.com/choria-io/asyncjobs/discussions><i class="far fa-comments"></i> Discussions</a></li><li><a class=padding href=https://github.com/choria-io/asyncjobs/issues><i class="far fa-life-ring"></i> Issues</a></li><li><a class=padding href=https://slack.puppet.com/><i class="fab fa-slack"></i> #choria</a></li></ul></div><div class="footermargin footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showVariantSwitch showFooter"></div><hr class="default-animation footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showVariantSwitch showFooter"><div id=prefooter class="footerLangSwitch footerVariantSwitch footerVisitedLinks showVariantSwitch"><ul><li id=select-language-container class=footerLangSwitch><a class="padding select-container"><i class="fas fa-language fa-fw"></i>
<span>&nbsp;</span><div class=select-style><select id=select-language onchange="location=baseUri+this.value"></select></div><div class=select-clear></div></a></li><li id=select-variant-container class="footerVariantSwitch showVariantSwitch"><a class="padding select-container"><i class="fas fa-paint-brush fa-fw"></i>
<span>&nbsp;</span><div class=select-style><select id=select-variant onchange=variants.changeVariant(this.value)><option id=relearn-light value=relearn-light selected>Relearn Light</option><option id=relearn-dark value=relearn-dark>Relearn Dark</option><option id=asyncjobs value=asyncjobs>Asyncjobs</option></select></div><div class=select-clear></div></a><script>variants.markSelectedVariant()</script></li><li class=footerVisitedLinks><a class=padding href=# data-clear-history-toggle><i class="fas fa-history fa-fw"></i> Clear History</a></li></ul></div><div id=footer class="footerFooter showFooter"><p>Built with <a href=https://github.com/McShelby/hugo-theme-relearn><i class="fas fa-heart"></i></a> by <a href=https://gohugo.io/>Hugo</a></p></div></div></aside><script src=https://choria-io.github.io/asyncjobs/js/clipboard.min.js?1653319849></script>
<script src=https://choria-io.github.io/asyncjobs/js/perfect-scrollbar.min.js?1653319849></script>
<script src=https://choria-io.github.io/asyncjobs/js/featherlight.min.js?1653319849></script>
<script src=https://choria-io.github.io/asyncjobs/js/theme.js?1653319849></script></body></html>